<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantHub Support Chatbot</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const SupportChatbot = () => {
            const [isOpen, setIsOpen] = useState(false);
            const [messages, setMessages] = useState([
                { role: 'assistant', content: 'Hi! I\'m the QuantHub support assistant. How can I help you today?' }
            ]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);

            const API_URL = 'http://localhost:3000/api/v1/chat';

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            // Convert markdown links to HTML
            const parseMarkdownLinks = (text) => {
                const linkRegex = /\[([^\]]+)\]\(([^)]+)\)/g;
                const parts = [];
                let lastIndex = 0;
                let match;

                while ((match = linkRegex.exec(text)) !== null) {
                    if (match.index > lastIndex) {
                        parts.push(text.substring(lastIndex, match.index));
                    }
                    parts.push(
                        <a 
                            key={match.index}
                            href={match[2]} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="text-blue-600 hover:text-blue-800 underline font-medium"
                        >
                            {match[1]}
                        </a>
                    );
                    lastIndex = match.index + match[0].length;
                }

                if (lastIndex < text.length) {
                    parts.push(text.substring(lastIndex));
                }

                return parts.length > 0 ? parts : text;
            };

            const handleSubmit = async () => {
                if (!input.trim() || isLoading) return;
                
                const userMessage = input.trim();
                setInput('');
                setMessages(prev => [...prev, { role: 'user', content: userMessage }]);
                setIsLoading(true);

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userMessage })
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: data.response,
                        sources: data.sources || []
                    }]);
                } catch (error) {
                    console.error('Error:', error);
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: 'Sorry, I encountered an error. Please try again or email support@quanthub.com'
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="fixed bottom-4 right-4 z-50">
                    {!isOpen && (
                        <button
                            onClick={() => setIsOpen(true)}
                            className="bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 transition-all hover:scale-110"
                        >
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                            </svg>
                        </button>
                    )}

                    {isOpen && (
                        <div className="bg-white rounded-lg shadow-2xl w-96 h-[600px] flex flex-col">
                            <div className="bg-blue-600 text-white p-4 rounded-t-lg flex justify-between items-center">
                                <div>
                                    <h3 className="font-semibold">QuantHub Support</h3>
                                    <p className="text-xs opacity-90">AI-powered assistance</p>
                                </div>
                                <button onClick={() => setIsOpen(false)} className="hover:bg-blue-700 rounded p-1 transition-colors">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                {messages.map((msg, idx) => (
                                    <div key={idx}>
                                        <div className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[85%] rounded-lg p-3 ${
                                                msg.role === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800'
                                            }`}>
                                                <p className="text-sm whitespace-pre-wrap leading-relaxed">
                                                    {typeof msg.content === 'string' && msg.role === 'assistant' 
                                                        ? parseMarkdownLinks(msg.content)
                                                        : msg.content
                                                    }
                                                </p>
                                            </div>
                                        </div>
                                        
                                        {msg.sources && msg.sources.length > 0 && (
                                            <div className="mt-2 ml-2">
                                                <p className="text-xs text-gray-500 mb-1.5 font-medium">ðŸ“š Related Articles:</p>
                                                <div className="space-y-1">
                                                    {msg.sources.map((source, sourceIdx) => (
                                                        <a
                                                            key={sourceIdx}
                                                            href={source.url}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="flex items-center text-xs text-blue-600 hover:text-blue-800 hover:bg-blue-50 p-2 rounded transition-colors"
                                                        >
                                                            <svg className="w-3 h-3 mr-1.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                            </svg>
                                                            <span className="flex-1">{source.title}</span>
                                                            <svg className="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                                            </svg>
                                                        </a>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                                
                                {isLoading && (
                                    <div className="flex justify-start">
                                        <div className="bg-gray-100 rounded-lg p-4">
                                            <div className="flex items-center space-x-2">
                                                <div className="flex space-x-1">
                                                    <div className="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style={{animationDelay: '0ms'}}></div>
                                                    <div className="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style={{animationDelay: '150ms'}}></div>
                                                    <div className="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style={{animationDelay: '300ms'}}></div>
                                                </div>
                                                <span className="text-xs text-gray-500">Searching knowledge base...</span>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                <div ref={messagesEndRef} />
                            </div>

                            <div className="border-t p-4 flex gap-2">
                                <input
                                    type="text"
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleSubmit()}
                                    placeholder="Ask a question..."
                                    className="flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm"
                                    disabled={isLoading}
                                />
                                <button
                                    onClick={handleSubmit}
                                    disabled={isLoading || !input.trim()}
                                    className="bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                >
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<SupportChatbot />);
    </script>
</body>
</html>
